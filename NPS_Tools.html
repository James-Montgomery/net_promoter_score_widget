<!DOCTYPE html>
<html>

<head>
  <script src="https://cdn.jsdelivr.net/npm/jstat@latest/dist/jstat.min.js"></script>
  <script>

  const average = arr => arr.reduce( ( p, c ) => p + c, 0 ) / arr.length;

  function percentile(arr, p) {
    arr.sort();
    if (arr.length === 0) return 0;
    if (typeof p !== 'number') throw new TypeError('p must be a number');
    if (p <= 0) return arr[0];
    if (p >= 1) return arr[arr.length - 1];

    var index = arr.length * p,
        lower = Math.floor(index),
        upper = lower + 1,
        weight = index % 1;

    if (upper >= arr.length) return arr[lower];
    return arr[lower] * (1 - weight) + arr[upper] * weight;
  }

  function sample_beta(alpha, beta, size) {
    var samples = [];
    var i = 0
    while(i < size){
      samples.push(
        jStat.beta.sample(alpha, beta)
      );
      i++
    }
    return samples;
  }

  function NPS(promotors, detractors) {
    nps = 100.0 * (promotors - detractors)
    return nps.toFixed(0)
  }

  function beta_binomial() {
    // set priors
    var alpha = 1.0;
    var beta = 1.0;
    // get data
    var promotors = document.getElementById("promotors").value;
    var passives = document.getElementById("passives").value;
    var detractors = document.getElementById("detractors").value;
    // cast as floats
    var promotors = parseFloat(promotors);
    var passives = parseFloat(passives);
    var detractors = parseFloat(detractors);
    // P(promoter)
    var n = (promotors + passives + detractors);
    var alpha_s = alpha + promotors;
    var beta_s = beta + n - promotors;
    var promotors_posterior = sample_beta(alpha_s, beta_s, 10000);
    // P(detractor|~promotor)
    var n = (passives + detractors);
    var alpha_s = alpha + detractors;
    var beta_s = beta + n - detractors;
    var conditional_detractors_posterior = sample_beta(alpha_s, beta_s, 10000);
    // P(detractor|~promotor) * P(~promotor)
    var not_promotors_posterior = promotors_posterior.map( function(value) {
      return 1.0 - value;
    } );
    var detractors_posterior = [];
    for(var i=0; i< conditional_detractors_posterior.length; i++) {
      detractors_posterior.push(
        conditional_detractors_posterior[i] * not_promotors_posterior[i]
      );
    }
    // NPS Posterior
    var nps_posterior = [];
    for(var i=0; i< promotors_posterior.length; i++) {
      var nps_score = NPS(
        promotors_posterior[i],
        detractors_posterior[i]
      )
      nps_posterior.push( nps_score )
    }
    console.log(nps_posterior)
    // Monte Carlo estimate posterior
    var map = percentile(nps_posterior, 0.5).toFixed(0);
    var lb = percentile(nps_posterior, 0.025).toFixed(0);
    var ub = percentile(nps_posterior, 0.975).toFixed(0);
    var output = `The 95% Credible is ${lb} to ${ub}. The MAP estimate is ${map}.`
    // print result to html element
    document.getElementById("results").innerHTML = output;
  }

  </script>
</head>

<body bgcolor="#3498DB">
  <h2>Estimate NPS Score</h2>
  <label for="promotors">Number of Promotors</label>
  <input type="number" id="promotors" value="50.0"><br>
  <label for="passives">Number of Passives &nbsp;&nbsp;</label>
  <input type="number" id="passives" value="100.0"><br>
  <label for="detractors">Number of Detractors</label>
  <input type="number" id="detractors" value="100.0"><br>
  <p id="results">Results will be displayed here.</p>
  <button onclick="beta_binomial()">Run Test</button>
</body>

</html>
